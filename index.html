<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Story Adventure with Dynamic Choice Cards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Default Dark background */
            color: #e2e8f0; /* Default Light text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            overflow: hidden; /* Prevent scrollbar during transitions */
            transition: background-color 0.8s ease-in-out, color 0.8s ease-in-out; /* Smooth background/text color transition */
        }
        .story-container {
            background-color: #2d3748; /* Slightly lighter dark background for container */
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2.5rem; /* Increased padding */
            max-width: 600px;
            width: 100%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative; /* For absolute positioning of elements */
            overflow: hidden; /* Keep elements within container */
        }
        .story-text {
            font-size: 1.125rem; /* Larger text */
            line-height: 1.75;
            text-align: center;
            opacity: 0; /* Start hidden for animation */
            animation: fadeIn 0.8s ease-out forwards; /* Fade in animation */
            position: relative; /* Ensure text is above elements if needed */
            z-index: 10;
        }
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            opacity: 0; /* Start hidden for animation */
            animation: fadeIn 0.8s ease-out forwards; /* Fade in animation */
            animation-delay: 0.3s; /* Delay choices fade-in slightly */
            position: relative;
            z-index: 10;
        }
        .choice-button {
            display: flex; /* Use flexbox for icon and text alignment */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Rounded buttons */
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, filter 0.3s ease; /* Added filter transition */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: white; /* Default text color, overridden by choiceStyle */
            filter: brightness(100%); /* For hover effect */
        }
        .choice-button:hover {
            transform: translateY(-2px);
            filter: brightness(120%); /* Slightly brighter on hover */
        }
        .choice-button:active {
            transform: translateY(0);
            filter: brightness(90%); /* Slightly darker on click */
        }
        .choice-button .icon {
            width: 24px; /* Icon size */
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .choice-button .icon svg {
            width: 100%;
            height: 100%;
            stroke: currentColor; /* Inherit color from button text */
            fill: currentColor; /* Inherit color from button text */
        }
        .choice-button .icon.emoji {
            font-size: 24px;
            line-height: 1; /* Adjust line height for emoji vertical alignment */
        }

        .restart-button {
            background-color: #e53e3e; /* Red for restart */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin-top: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .restart-button:hover {
            background-color: #c53030; /* Darker red on hover */
            transform: translateY(-2px);
        }
        .restart-button:active {
            transform: translateY(0);
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* Environment elements styling */
        .env-element {
            position: absolute;
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            z-index: 1; /* Behind text and choices */
        }
        /* Specific positioning for elements */
        .env-element.top-left { top: 10%; left: 10%; }
        .env-element.top-right { top: 10%; right: 10%; }
        .env-element.bottom-left { bottom: 10%; left: 10%; }
        .env-element.bottom-right { bottom: 10%; right: 10%; }
        .env-element.center-top { top: 5%; left: 50%; transform: translateX(-50%); }
        .env-element.center-bottom { bottom: 5%; left: 50%; transform: translateX(-50%); }
        .env-element.center { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .env-element.middle-left { top: 50%; left: 5%; transform: translateY(-50%); }
        .env-element.middle-right { top: 50%; right: 5%; transform: translateY(-50%); }

        /* SVG specific styles for better cartoon look */
        .env-element svg {
            width: 80px; /* Default size */
            height: 80px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3)); /* Subtle glow */
        }
        .env-element.large svg {
            width: 150px;
            height: 150px;
        }
        .env-element.small svg {
            width: 50px;
            height: 50px;
        }
    </style>
</head>
<body>
    <div class="story-container">
        <div id="environment-elements-container" class="absolute inset-0">
            <!-- Environment-specific SVG/Emoji elements will be injected here -->
        </div>
        <div id="story-text" class="story-text"></div>
        <div id="choices-container" class="choices-container"></div>
        <button id="restart-button" class="restart-button hidden">Start Over</button>
    </div>

    <script>
        // Define the story nodes (scenes) with environment properties and elements
        const story = {
            start: {
                text: "You awaken in a dimly lit chamber, a strange hum vibrating through the air. A single, ancient door stands before you, etched with glowing symbols. What do you do?",
                choices: [
                    {
                        text: "Examine the symbols on the door.",
                        next: "examine_symbols",
                        choiceStyle: {
                            bgColor: '#5A67D8', // Indigo
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2L2 22h20L12 2z"/><circle cx="12" cy="12" r="4"/><path d="M2 12h20M12 2v20"/></svg>' // Symbol icon
                        }
                    },
                    {
                        text: "Try to open the door.",
                        next: "open_door_attempt",
                        choiceStyle: {
                            bgColor: '#9F7AEA', // Purple
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"/><path d="M12 2v20"/></svg>' // Door icon
                        }
                    },
                    {
                        text: "Look for another exit.",
                        next: "look_for_exit",
                        choiceStyle: {
                            bgColor: '#48BB78', // Green
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 20V6a2 2 0 00-2-2H8a2 2 0 00-2 2v14L2 18V4a2 2 0 012-2h16a2 2 0 012 2v14l-4 2z"/></svg>' // Exit sign icon (simplified)
                        }
                    }
                ],
                env: {
                    bgColor: '#1a202c', // Dark chamber
                    textColor: '#e2e8f0',
                    elements: [
                        { type: 'svg', name: 'torch-left', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><path d="M12 18s-2-2-2-3c0-1.1.9-2 2-2s2 .9 2 2c0 1-2 3-2 3z"/></svg>', class: 'top-left small' },
                        { type: 'svg', name: 'torch-right', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><path d="M12 18s-2-2-2-3c0-1.1.9-2 2-2s2 .9 2 2c0 1-2 3-2 3z"/></svg>', class: 'top-right small' },
                        { type: 'svg', name: 'ancient-door', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#8B4513" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"/><path d="M12 2v20"/><path d="M7 7h.01"/><path d="M17 7h.01"/></svg>', class: 'center large' },
                        { type: 'svg', name: 'glowing-symbols', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#00FFFF" stroke="#00FFFF" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 22h20L12 2z"/><circle cx="12" cy="12" r="4"/><path d="M2 12h20M12 2v20"/></svg>', class: 'center-top small' }
                    ]
                }
            },
            examine_symbols: {
                text: "The symbols pulse faintly. They seem to depict a celestial map, but one you don't recognize. As you trace them, a section of the wall slides open, revealing a narrow, dark passage.",
                choices: [
                    {
                        text: "Enter the dark passage.",
                        next: "enter_passage",
                        choiceStyle: {
                            bgColor: '#2D3748', // Dark grey
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 3h4c.55 0 1 .45 1 1v16c0 .55-.45 1-1 1h-4c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1z"/><path d="M12 2v20"/></svg>' // Passage icon
                        }
                    },
                    {
                        text: "Return to the main chamber and try the door.",
                        next: "open_door_attempt",
                        choiceStyle: {
                            bgColor: '#9F7AEA', // Purple
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"/><path d="M12 2v20"/></svg>' // Door icon
                        }
                    }
                ],
                env: {
                    bgColor: '#1a202c',
                    textColor: '#e2e8f0',
                    elements: [
                        { type: 'svg', name: 'open-passage', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3h4c.55 0 1 .45 1 1v16c0 .55-.45 1-1 1h-4c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1z"/><path d="M12 2v20"/></svg>', class: 'middle-right large' },
                        { type: 'svg', name: 'glowing-symbols-active', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#00FFFF" stroke="#00FFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 22h20L12 2z"/><circle cx="12" cy="12" r="4"/><path d="M2 12h20M12 2v20"/></svg>', class: 'center-top small' }
                    ]
                }
            },
            open_door_attempt: {
                text: "You push against the heavy door. It groans, but remains sealed. A faint whisper seems to emanate from within, urging you to find another way.",
                choices: [
                    {
                        text: "Look for another exit.",
                        next: "look_for_exit",
                        choiceStyle: {
                            bgColor: '#48BB78', // Green
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 20V6a2 2 0 00-2-2H8a2 2 0 00-2 2v14L2 18V4a2 2 0 012-2h16a2 2 0 012 2v14l-4 2z"/></svg>' // Exit sign icon
                        }
                    },
                    {
                        text: "Examine the symbols on the door more closely.",
                        next: "examine_symbols",
                        choiceStyle: {
                            bgColor: '#5A67D8', // Indigo
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2L2 22h20L12 2z"/><circle cx="12" cy="12" r="4"/><path d="M2 12h20M12 2v20"/></svg>' // Symbol icon
                        }
                    }
                ],
                env: {
                    bgColor: '#1a202c',
                    textColor: '#e2e8f0',
                    elements: [
                        { type: 'svg', name: 'torch-left', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><path d="M12 18s-2-2-2-3c0-1.1.9-2 2-2s2 .9 2 2c0 1-2 3-2 3z"/></svg>', class: 'top-left small' },
                        { type: 'svg', name: 'torch-right', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><path d="M12 18s-2-2-2-3c0-1.1.9-2 2-2s2 .9 2 2c0 1-2 3-2 3z"/></svg>', class: 'top-right small' },
                        { type: 'svg', name: 'ancient-door-sealed', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#8B4513" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"/><path d="M12 2v20"/><path d="M7 7h.01"/><path d="M17 7h.01"/><path d="M12 12L12 12" stroke="#FF0000" stroke-width="4"/></svg>', class: 'center large' },
                        { type: 'emoji', name: 'whisper', content: '👻', class: 'top-left small' }
                    ]
                }
            },
            look_for_exit: {
                text: "You search the perimeter of the chamber. Behind a crumbling pillar, you find a small, hidden lever. Pulling it reveals a secret hatch in the floor.",
                choices: [
                    {
                        text: "Descend into the hatch.",
                        next: "descend_hatch",
                        choiceStyle: {
                            bgColor: '#6B46C1', // Darker purple
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20"/></svg>' // Hatch icon
                        }
                    },
                    {
                        text: "Ignore the hatch and try the door again.",
                        next: "open_door_attempt",
                        choiceStyle: {
                            bgColor: '#9F7AEA', // Purple
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"/><path d="M12 2v20"/></svg>' // Door icon
                        }
                    }
                ],
                env: {
                    bgColor: '#1a202c',
                    textColor: '#e2e8f0',
                    elements: [
                        { type: 'svg', name: 'pillar', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="7" y="2" width="10" height="20" rx="2" ry="2"/><path d="M7 12h10"/></svg>', class: 'middle-left large' },
                        { type: 'svg', name: 'lever', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#A0AEC0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="10" y="2" width="4" height="10" rx="1" ry="1"/><path d="M12 12v8M12 20h2"/></svg>', class: 'bottom-left small' },
                        { type: 'svg', name: 'hatch', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#8B4513" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20"/></svg>', class: 'center-bottom large' }
                    ]
                }
            },
            enter_passage: {
                text: "The passage is cold and damp. After a long walk, you emerge into a vast cavern filled with glowing crystals. In the center, a shimmering portal beckons.",
                choices: [
                    {
                        text: "Step through the portal.",
                        next: "portal_destination",
                        choiceStyle: {
                            bgColor: '#805AD5', // Dark purple
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20M5 5l14 14M5 19l14-14"/></svg>' // Portal icon
                        }
                    },
                    {
                        text: "Examine the crystals.",
                        next: "examine_crystals",
                        choiceStyle: {
                            bgColor: '#667EEA', // Blue-purple
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l-5 10h10l-5 10z"/></svg>' // Crystal icon
                        }
                    }
                ],
                env: {
                    bgColor: '#0F172A', // Colder, deep blue
                    textColor: '#93C5FD', // Lighter blue for text
                    elements: [
                        { type: 'svg', name: 'crystal1', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#8B5CF6" stroke="#C4B5FD" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l-5 10h10l-5 10z"/></svg>', class: 'top-left small' },
                        { type: 'svg', name: 'crystal2', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#8B5CF6" stroke="#C4B5FD" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l-5 10h10l-5 10z"/></svg>', class: 'bottom-right small' },
                        { type: 'svg', name: 'portal', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20M5 5l14 14M5 19l14-14"/></svg>', class: 'center large' }
                    ]
                }
            },
            descend_hatch: {
                text: "You slide down a chute, landing softly in a room filled with ancient machinery. A large, dusty console has a single, glowing red button.",
                choices: [
                    {
                        text: "Press the red button.",
                        next: "press_button",
                        choiceStyle: {
                            bgColor: '#E53E3E', // Red
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/></svg>' // Button icon
                        }
                    },
                    {
                        text: "Try to understand the machinery first.",
                        next: "understand_machinery",
                        choiceStyle: {
                            bgColor: '#6B7280', // Grey
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" ry="2"/><circle cx="6" cy="12" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="18" cy="12" r="1"/></svg>' // Console icon
                        }
                    }
                ],
                env: {
                    bgColor: '#2C3E50', // Industrial, metallic
                    textColor: '#ECF0F1',
                    elements: [
                        { type: 'svg', name: 'gear1', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#7F8C8D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"/><path d="M12 2v20M2 12h20M5 5l14 14M5 19l14-14"/></svg>', class: 'top-left large' },
                        { type: 'svg', name: 'gear2', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#7F8C8D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"/><path d="M12 2v20M2 12h20M5 5l14 14M5 19l14-14"/></svg>', class: 'bottom-right large' },
                        { type: 'svg', name: 'red-button', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FF0000" stroke="#FF0000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"/></svg>', class: 'center small' }
                    ]
                }
            },
            portal_destination: {
                text: "You step through the portal and find yourself on a vibrant, alien world, bathed in the light of two suns. A new adventure begins!",
                choices: [], // End of story
                env: {
                    bgColor: '#FF6347', // Vibrant, alien world
                    textColor: '#FFFFE0',
                    elements: [
                        { type: 'svg', name: 'sun1', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700" stroke="#FFD700" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="6"/><path d="M12 2v2m0 18v2m9-9h2M1 12h2m15.36-7.36l-1.42-1.42m-12.72 12.72l-1.42 1.42m7.07-19.07l-1.42 1.42M3.64 20.36l1.42-1.42"/></svg>', class: 'top-left large' },
                        { type: 'svg', name: 'sun2', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFA07A" stroke="#FFA07A" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="6"/><path d="M12 2v2m0 18v2m9-9h2M1 12h2m15.36-7.36l-1.42-1.42m-12.72 12.72l-1.42 1.42m7.07-19.07l-1.42 1.42M3.64 20.36l1.42-1.42"/></svg>', class: 'top-right large' },
                        { type: 'emoji', name: 'alien-plant', content: '🌿', class: 'bottom-left small' },
                        { type: 'emoji', name: 'alien-rock', content: '🪨', class: 'bottom-right small' }
                    ]
                }
            },
            examine_crystals: {
                text: "As you touch a crystal, it flares brightly, and a vision flashes through your mind: a forgotten history of this chamber. You now understand the door's symbols and how to activate them from here.",
                choices: [
                    {
                        text: "Activate the symbols to open the main door.",
                        next: "open_main_door_from_crystals",
                        choiceStyle: {
                            bgColor: '#38A169', // Darker green
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2L2 22h20L12 2z"/><circle cx="12" cy="12" r="4"/></svg>' // Symbol icon
                        }
                    },
                    {
                        text: "Still step through the portal.",
                        next: "portal_destination",
                        choiceStyle: {
                            bgColor: '#805AD5', // Dark purple
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20M5 5l14 14M5 19l14-14"/></svg>' // Portal icon
                        }
                    }
                ],
                env: {
                    bgColor: '#0F172A',
                    textColor: '#93C5FD',
                    elements: [
                        { type: 'svg', name: 'crystal-flaring', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#8B5CF6" stroke="#E0BBE4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l-5 10h10l-5 10z"/><circle cx="12" cy="12" r="8" fill="rgba(255,255,0,0.3)"/></svg>', class: 'center large' },
                        { type: 'svg', name: 'portal', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20M5 5l14 14M5 19l14-14"/></svg>', class: 'bottom-right large' }
                    ]
                }
            },
            open_main_door_from_crystals: {
                text: "With your new knowledge, you focus on the symbols. The ancient door in the main chamber slowly grinds open, revealing a path to freedom!",
                choices: [], // End of story
                env: {
                    bgColor: '#1a202c',
                    textColor: '#e2e8f0',
                    elements: [
                        { type: 'svg', name: 'open-door-freedom', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#8B4513" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"/><path d="M12 2v20"/><path d="M7 7h.01"/><path d="M17 7h.01"/><path d="M12 12L20 12" stroke="#00FF00" stroke-width="4"/></svg>', class: 'center large' },
                        { type: 'emoji', name: 'sparkle', content: '✨', class: 'top-left small' },
                        { type: 'emoji', name: 'sparkle', content: '✨', class: 'top-right small' }
                    ]
                }
            },
            press_button: {
                text: "You press the red button. Alarms blare, and the room begins to fill with a strange, green gas. You realize too late this was a trap!",
                choices: [], // End of story (bad ending)
                env: {
                    bgColor: '#8B0000', // Alarming red
                    textColor: '#FFD700',
                    elements: [
                        { type: 'svg', name: 'alarm', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700" stroke="#FF0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10H2L12 22z"/><path d="M12 2v8"/></svg>', class: 'top-left large' },
                        { type: 'svg', name: 'gas', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#00FF00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14s1-1 4-1 5 2 8 2 4-1 4-1V2H4z"/></svg>', class: 'bottom-right large' },
                        { type: 'svg', name: 'red-button-pressed', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FF0000" stroke="#FF0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"/><circle cx="12" cy="12" r="4" fill="#FFA07A"/></svg>', class: 'center small' }
                    ]
                }
            },
            understand_machinery: {
                text: "You carefully study the console. It's a complex teleportation device, but it's missing a key component. You realize you need to find something to power it.",
                choices: [
                    {
                        text: "Go back up the hatch to look for clues.",
                        next: "look_for_exit",
                        choiceStyle: {
                            bgColor: '#6B46C1', // Darker purple
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20M5 5l14 14M5 19l14-14"/></svg>' // Hatch icon
                        }
                    },
                    {
                        text: "Give up and press the red button anyway.",
                        next: "press_button",
                        choiceStyle: {
                            bgColor: '#E53E3E', // Red
                            textColor: '#FFFFFF',
                            iconHtml: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/></svg>' // Button icon
                        }
                    }
                ],
                env: {
                    bgColor: '#2C3E50',
                    textColor: '#ECF0F1',
                    elements: [
                        { type: 'svg', name: 'console', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#7F8C8D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2" ry="2"/><circle cx="6" cy="12" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="18" cy="12" r="1"/><path d="M10 9h4m-4 6h4"/></svg>', class: 'center large' },
                        { type: 'emoji', name: 'question', content: '❓', class: 'top-right small' }
                    ]
                }
            },
            // Endings (these are not directly navigated to, but represent final states)
            win_portal: {
                text: "Congratulations! You've found a new world and a fresh start. Your adventure continues beyond this chamber!",
                choices: [],
                env: {
                    bgColor: '#FF6347',
                    textColor: '#FFFFE0',
                    elements: [
                        { type: 'emoji', name: 'star', content: '🌟', class: 'center large' }
                    ]
                }
            },
            win_door: {
                text: "Success! You've escaped the mysterious chamber and found your way to freedom. What will your next journey be?",
                choices: [],
                env: {
                    bgColor: '#1a202c',
                    textColor: '#e2e8f0',
                    elements: [
                        { type: 'emoji', name: 'door-open', content: '🚪', class: 'center large' }
                    ]
                }
            },
            lose_gas: {
                text: "The gas fills the room, and your vision blurs. This was not the escape you hoped for. Game Over.",
                choices: [],
                env: {
                    bgColor: '#8B0000',
                    textColor: '#FFD700',
                    elements: [
                        { type: 'emoji', name: 'skull', content: '💀', class: 'center large' }
                    ]
                }
            }
        };

        let currentScene = 'start';

        const storyTextElement = document.getElementById('story-text');
        const choicesContainerElement = document.getElementById('choices-container');
        const restartButton = document.getElementById('restart-button');
        const envElementsContainer = document.getElementById('environment-elements-container');

        // Function to render environment elements
        function renderEnvironmentElements(elements) {
            // First, fade out existing elements
            Array.from(envElementsContainer.children).forEach(child => {
                child.style.animation = 'fadeOut 0.3s ease-out forwards';
            });

            // Clear existing elements after fade out
            setTimeout(() => {
                envElementsContainer.innerHTML = '';
                elements.forEach(el => {
                    const div = document.createElement('div');
                    div.classList.add('env-element', el.class);
                    if (el.type === 'svg') {
                        div.innerHTML = el.html;
                    } else if (el.type === 'emoji') {
                        div.textContent = el.content;
                        div.style.fontSize = '80px'; // Adjust emoji size
                    }
                    envElementsContainer.appendChild(div);
                });
            }, 300); // Wait for fade out to complete
        }

        // Function to display a scene with animations and environment changes
        function showScene(sceneKey) {
            const scene = story[sceneKey];

            // Apply fade-out animation to current content
            storyTextElement.style.animation = 'fadeOut 0.3s ease-out forwards';
            choicesContainerElement.style.animation = 'fadeOut 0.3s ease-out forwards';
            restartButton.style.animation = 'fadeOut 0.3s ease-out forwards';

            // Update body background and text color
            document.body.style.backgroundColor = scene.env.bgColor;
            document.body.style.color = scene.env.textColor;

            // Render environment elements
            renderEnvironmentElements(scene.env.elements);

            // Wait for fade-out to complete before updating content and fading in new content
            setTimeout(() => {
                currentScene = sceneKey;

                storyTextElement.textContent = scene.text;
                choicesContainerElement.innerHTML = ''; // Clear previous choices

                // Reset animation and apply fade-in for text and choices
                storyTextElement.style.animation = 'fadeIn 0.8s ease-out forwards';
                choicesContainerElement.style.animation = 'fadeIn 0.8s ease-out forwards';
                choicesContainerElement.style.animationDelay = '0.3s'; // Delay choices fade-in

                if (scene.choices.length === 0) {
                    // If it's an ending, show restart button
                    restartButton.classList.remove('hidden');
                    restartButton.style.animation = 'fadeIn 0.8s ease-out forwards';
                    restartButton.style.animationDelay = '0.6s'; // Delay restart button fade-in
                } else {
                    restartButton.classList.add('hidden');
                    scene.choices.forEach(choice => {
                        const button = document.createElement('button');
                        button.classList.add('choice-button');

                        // Apply choice-specific styles
                        if (choice.choiceStyle) {
                            button.style.backgroundColor = choice.choiceStyle.bgColor;
                            button.style.color = choice.choiceStyle.textColor;

                            const iconSpan = document.createElement('span');
                            iconSpan.classList.add('icon');
                            if (choice.choiceStyle.iconHtml) {
                                iconSpan.innerHTML = choice.choiceStyle.iconHtml;
                            } else if (choice.choiceStyle.iconEmoji) {
                                iconSpan.textContent = choice.choiceStyle.iconEmoji;
                                iconSpan.classList.add('emoji');
                            }
                            button.appendChild(iconSpan);
                        }

                        const textSpan = document.createElement('span');
                        textSpan.textContent = choice.text;
                        button.appendChild(textSpan);

                        button.addEventListener('click', () => {
                            showScene(choice.next);
                        });
                        choicesContainerElement.appendChild(button);
                    });
                }
            }, 300); // Duration of fadeOut animation
        }

        // Event listener for restart button
        restartButton.addEventListener('click', () => {
            // Apply fade-out animation to current content before restarting
            storyTextElement.style.animation = 'fadeOut 0.3s ease-out forwards';
            choicesContainerElement.style.animation = 'fadeOut 0.3s ease-out forwards';
            restartButton.style.animation = 'fadeOut 0.3s ease-out forwards';
            Array.from(envElementsContainer.children).forEach(child => {
                child.style.animation = 'fadeOut 0.3s ease-out forwards';
            });

            setTimeout(() => {
                showScene('start');
            }, 300); // Duration of fadeOut animation
        });

        // Initialize the story by showing the first scene
        // No fade-out needed for the very first scene load
        const initialScene = story[currentScene];
        storyTextElement.textContent = initialScene.text;
        initialScene.choices.forEach(choice => {
            const button = document.createElement('button');
            button.classList.add('choice-button');

            // Apply choice-specific styles for initial load
            if (choice.choiceStyle) {
                button.style.backgroundColor = choice.choiceStyle.bgColor;
                button.style.color = choice.choiceStyle.textColor;

                const iconSpan = document.createElement('span');
                iconSpan.classList.add('icon');
                if (choice.choiceStyle.iconHtml) {
                    iconSpan.innerHTML = choice.choiceStyle.iconHtml;
                } else if (choice.choiceStyle.iconEmoji) {
                    iconSpan.textContent = choice.choiceStyle.iconEmoji;
                    iconSpan.classList.add('emoji');
                }
                button.appendChild(iconSpan);
            }

            const textSpan = document.createElement('span');
            textSpan.textContent = choice.text;
            button.appendChild(textSpan);

            button.addEventListener('click', () => {
                showScene(choice.next);
            });
            choicesContainerElement.appendChild(button);
        });
        // Ensure initial elements are visible with fade-in
        storyTextElement.style.animation = 'fadeIn 0.8s ease-out forwards';
        choicesContainerElement.style.animation = 'fadeIn 0.8s ease-out forwards';
        choicesContainerElement.style.animationDelay = '0.3s';
        // Render initial environment elements
        renderEnvironmentElements(initialScene.env.elements);
    </script>
</body>
</html>
